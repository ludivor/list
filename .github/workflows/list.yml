name: update

on:
  schedule:
    - cron: '34 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  descarga_reemplazo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: build
        id: gen
        shell: bash
        run: |
          set -euo pipefail
          trap 's=$?; echo "Error en lÃ­nea $LINENO: $BASH_COMMAND (exit $s)" >&2; exit $s' ERR
          
          SALIDAS=(
            "original.m3u|https://ipfs.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u|127.0.0.1:6878|127.0.0.1:6878"
            "ne_mod.m3u|https://ipfs.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u|http://127.0.0.1:6878|http://10.0.0.242:8080"
            "ec_mod.m3u|https://ipfs.io/ipns/k51qzi5uqu5di462t7j4vu4akwfhvtjhy88qbupktvoacqfqe9uforjvhyi4wr/hashes.m3u|http://127.0.0.1:6878|http://10.0.0.242:8080"
            "ic_mod.m3u|https://raw.githubusercontent.com/Icastresana/lista1/main/peticiones|http://127.0.0.1:6878|http://10.0.0.242:8080"
            "ev_mod.m3u|https://raw.githubusercontent.com/Icastresana/lista1/refs/heads/main/eventos.m3u|acestream://|http://10.0.0.242:8080/ace/getstream?id="
            "ss_mod.m3u|https://raw.githubusercontent.com/ludivor/ssiptv/refs/heads/main/docs/lista.m3u|http://10.0.0.242:8080|http://192.168.1.50:6878/ace/getstream?id="
          )

          PATHS_FILE="$RUNNER_TEMP/paths_to_add.txt"
          : > "$PATHS_FILE"

          declare -A CACHE_URL_FILE=()
          TMP_DIR="$(mktemp -d)"
          cleanup_all() { rm -rf "$TMP_DIR"; }
          trap cleanup_all EXIT

          fetch_url() {
            local url="$1"
            local f="$2"

            echo "Descargando: $url" >&2
            curl -L --fail \
              --connect-timeout 10 \
              --max-time 120 \
              --retry 5 \
              --retry-delay 2 \
              --retry-max-time 180 \
              --retry-connrefused \
              "$url" -o "$f"
            test -s "$f"
          }

          get_source_for_url() {
            local url="$1"

            if [[ -n "${CACHE_URL_FILE[$url]:-}" ]]; then
              echo "${CACHE_URL_FILE[$url]}"
              return 0
            fi

            local f="$TMP_DIR/src_$(printf '%s' "$url" | sha1sum | awk '{print $1}').m3u"

            if ! fetch_url "$url" "$f"; then
              return 1
            fi

            CACHE_URL_FILE["$url"]="$f"
            echo "$f"
          }

          FAILED_URLS=()

          echo "ðŸ”„ Iniciando procesamiento de listas..."

          for item in "${SALIDAS[@]}"; do
            IFS='|' read -r OUT URL BUSCAR REEMPLAZAR <<< "$item"

            echo ""
            echo "âž¡ï¸ Procesando: $OUT"

            if ! src_file="$(get_source_for_url "$URL" 2>/dev/null)"; then
              echo "âŒ Error descargando $URL"
              FAILED_URLS+=("$URL")
              continue
            fi

            tmp_out="${OUT}.new"

            if ! sed "s#${BUSCAR}#${REEMPLAZAR}#g" "$src_file" > "$tmp_out"; then
              echo "âŒ Error aplicando sed a $OUT"
              FAILED_URLS+=("$URL")
              continue
            fi

            if ! test -s "$tmp_out"; then
              echo "âŒ Archivo generado vacÃ­o para $OUT"
              FAILED_URLS+=("$URL")
              continue
            fi

            mv "$tmp_out" "$OUT"
            printf '%s\n' "$OUT" >> "$PATHS_FILE"
            echo "âœ… Generado correctamente: $OUT"
          done

          echo ""
          echo "ðŸ“‹ Resumen final"
          echo "----------------------------------"
          if [[ ${#FAILED_URLS[@]} -eq 0 ]]; then
            echo "ðŸŽ‰ Todas las URLs se procesaron correctamente"
          else
            echo "âš ï¸ URLs que fallaron:"
            for u in "${FAILED_URLS[@]}"; do
              echo "   - $u"
            done
          fi
          echo "----------------------------------"

          echo "paths_file=$PATHS_FILE" >> "$GITHUB_OUTPUT"

      - name: Verify
        id: verify_diff
        shell: bash
        run: |
          set -euo pipefail
          git add --pathspec-from-file="${{ steps.gen.outputs.paths_file }}"
          if git diff --staged --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit docs
        if: steps.verify_diff.outputs.changed == 'true'
        shell: bash
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git commit -m "ðŸ¤– Lista M3U - $(TZ='Europe/Madrid' date +'%Y-%m-%d %H:%M:%S')"
          git push
